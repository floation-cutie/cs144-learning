#### 网络层

##### 设计选择

核心功能:分组转发和路由选择

向上层提供两种服务

1. 面向连接的虚电路服务

   1. 核心思想：==可靠通信由网络本身保证==  丢包率小，通信质量高
   2. 通信双方沿着已建立的虚电路发送分组

2. 无连接的数据报服务

   1. 核心思想：==可靠通信由用户主机保证== 上层决定

   2. 不需要建立网络层连接

   3. 每个分组可走不同路径，首部必须携带目标主机地址

   4. 通信结束后，没有需要释放的连接

      这种方式的路由器设计简单，所传送的分组可能**误码，丢失，重复，失序**

##### 网络层协议

二进制协议 需定义长度

###### 1.IPv4数据报格式

​	数据格式以4字节为单位进行描述  由首部和数据两部分组成

​	数据为传输层传递的segment数据段

​				这是首部

![image-20240208141810896](C:\Users\WESLEY\AppData\Roaming\Typora\typora-user-images\image-20240208141810896.png)

首部长度：范围是0-15 占四个bit ==不表示实际长度，而是权值== 乘以4才是最终长度

从0101 - - 1111	IP协议长度是变长的 可选字段用于增加IPv4数据报的功能  填充部分使用全0进行填充

###### 2.首部协议

Differentiated services field 区分服务用于提高网络服务质量

总长度 16-31 两个字节   65535  而进入链路层 MTU最大为1500字节     总数据:IP头+IP数据报的数据负荷

**对大数据包需要进行拆包，每个小包都需要对应的IP头**

==标识，标记与位偏移==

![image-20240208150446030](C:\Users\WESLEY\AppData\Roaming\Typora\typora-user-images\image-20240208150446030.png)

当数据包过⼤进⾏分⽚时，同⼀个数据包的所有⽚的标识都是⼀样的

但是仅仅标识相同不代表归属于同一个数据包！

● 有⼀个计数器专⻔管理数据包的ID，每发出⼀个数据包，ID就加1 ==其存在循环重复的可能==





● 最低位（More Fragment，MF）

○ MF=1表示本分⽚后⾯还有分⽚

○ MF=0表示本分⽚后⾯没有分⽚ (无后续更多分片)

● 中间位（Don’t Fragment，DF）

○ DF=1表示不允许分⽚

○ DF=0表示允许分⽚

● 最⾼位为保留位，必须设置为0

通过片偏移排序  片偏移乘8为字节偏移  13bit

解决数据粘包   **分片**概念

![image-20240208163100257](C:\Users\WESLEY\AppData\Roaming\Typora\typora-user-images\image-20240208163100257.png)

由于字节偏移最终要求是8的倍数

20 + 0 - - 775   			  20 + 776 - - 1551 			 20 + 1552 - - 1559

##### ICMP头

IP头后的数据报中有对应协议头  ICMP头为8字节 data的构造方式是ascii码表的重复

很多服务器对大数据包拒绝请求	抓包软件无法捕获多个icmp的原因 标识icmp的ip协议标志 后续数据包中无icmp标志了，只是普通数据  协议标志为IPv4  疑问:反转了?

###### 生命周期 

time to live  ttl 占8bit

生存时间ttl字段的作用: ==防止被错误路由的IPv4数据报无限制地在因特网路由环路中兜圈==